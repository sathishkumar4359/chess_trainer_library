<header>
    <button class="nav-btn" style="background:#444" onclick="window.location.href='index.html'">BACK</button>
    <button id="whiteBtn" class="nav-btn" style="background:#fff; color:#000;" onclick="setMode('white')">WHITE MODE</button>
    <button id="blackBtn" class="nav-btn" style="background:#000; color:#fff; border:1px solid #444;" onclick="setMode('black')">BLACK MODE</button>
    
    <button class="nav-btn" style="background:#4583b6" onclick="exportJSON()">EXPORT</button>
    <button class="nav-btn" style="background:#fa412d" onclick="clearAll()">WIPE</button>
</header>

<script>
    let board = null, game = new Chess(), repoData = [], currentPath = [], moveIndex = 0, currentIdx = -1;
    let trainerMode = 'white'; // Default mode

    const sounds = { 
        move: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_standard_/default/move-self.mp3'), 
        capture: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_standard_/default/capture.mp3') 
    };

    window.onload = () => {
        board = Chessboard('board', { 
            draggable: true, position: 'start',
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
            onDrop: handleMove, onSnapEnd: () => board.position(game.fen())
        });

        const saved = localStorage.getItem('active_opening');
        if (saved) {
            repoData = JSON.parse(saved);
            renderSidebar();
            // Automatically detect if it's likely a black opening
            const name = repoData[0].name.toLowerCase();
            if (name.includes("sicilian") || name.includes("black")) {
                setMode('black');
            } else {
                setMode('white');
            }
        }
    };

    function setMode(mode) {
        trainerMode = mode;
        board.orientation(mode);
        
        // UI Feedback
        document.getElementById('whiteBtn').style.opacity = (mode === 'white') ? "1" : "0.5";
        document.getElementById('blackBtn').style.opacity = (mode === 'black') ? "1" : "0.5";
        
        loadOpening(currentIdx !== -1 ? currentIdx : 0);
    }

    function handleMove(source, target) {
        let move = game.move({ from: source, to: target, promotion: 'q' });
        if (!move || move.san !== currentPath[moveIndex]) { 
            if (move) game.undo(); 
            return 'snapback'; 
        }
        processMove(move);
    }

    function processMove(move) {
        move.san.includes('x') ? sounds.capture.play() : sounds.move.play();
        moveIndex++;
        board.position(game.fen());
        
        // Computer automatically responds if moves are left
        if (moveIndex < currentPath.length) {
            setTimeout(() => {
                let reply = game.move(currentPath[moveIndex++]);
                board.position(game.fen());
                reply.san.includes('x') ? sounds.capture.play() : sounds.move.play();
                if (moveIndex === currentPath.length) $("#status-msg").text("Line Complete!");
            }, 500);
        } else {
            $("#status-msg").text("Line Complete!");
        }
    }

    function loadOpening(idx) {
        currentIdx = idx;
        game.reset();
        const pgn = repoData[idx].raw.replace(/\[.*?\]/g, '').trim();
        game.load_pgn(pgn);
        currentPath = game.history();
        moveIndex = 0;
        board.start();

        // AUTOMATION LOGIC: If Black mode, computer plays 1. e4 (White's first move)
        if (trainerMode === 'black' && moveIndex < currentPath.length) {
            $("#status-msg").text("White is moving...");
            setTimeout(() => {
                let firstMove = game.move(currentPath[moveIndex++]);
                board.position(game.fen());
                sounds.move.play();
                $("#status-msg").text("Your turn (Black)");
            }, 600);
        } else {
            $("#status-msg").text("Your turn (White)");
        }
        renderSidebar();
    }

    function renderSidebar() {
        document.getElementById('repoList').innerHTML = repoData.map((item, i) => `
            <div class="repo-item ${currentIdx==i?'active':''}" onclick="loadOpening(${i})">${item.name}</div>`).join('');
    }

    function resetDrill() { loadOpening(currentIdx); }
    function clearAll() { localStorage.clear(); window.location.href='index.html'; }
</script>
