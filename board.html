<!DOCTYPE html>
<html>
<head>
    <title>ChessReps | Trainer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body { background: #121212; color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { background: #1e1e1e; padding: 10px; display: flex; justify-content: center; gap: 10px; border-bottom: 2px solid #312e2b; }
        main { display: flex; flex: 1; flex-wrap: wrap; overflow-y: auto; }
        .board-container { flex: 2; display: flex; flex-direction: column; align-items: center; padding: 10px; }
        #board { width: 95vw; max-width: 450px; }
        /* Chess.com Theme */
        .white-1e1d7 { background-color: #ebecd0 !important; }
        .black-3c85d { background-color: #779556 !important; }
        .side-bar { flex: 1; background: #262421; min-width: 300px; border-left: 1px solid #312e2b; padding: 10px; }
        .btn { padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; }
        .btn-white { background: #f0f0f0; color: #000; }
        .btn-black { background: #000; color: #fff; border: 1px solid #444; }
        .line-item { padding: 10px; border-bottom: 1px solid #312e2b; cursor: pointer; font-size: 14px; }
        .line-item:hover { background: #333; }
        .active { border-left: 4px solid #81b64c; background: #2d2b28; }
    </style>
</head>
<body>
    <header>
        <button class="btn" style="background:#444" onclick="window.location.href='index.html'">BACK</button>
        <button class="btn btn-white" onclick="startAs('white')">PLAY WHITE</button>
        <button class="btn btn-black" onclick="startAs('black')">PLAY BLACK</button>
    </header>
    <main>
        <div class="board-container">
            <div id="board"></div>
            <p id="msg" style="color:#81b64c; font-weight:bold; margin-top:15px;">Select a mode to begin</p>
        </div>
        <div class="side-bar">
            <h3 id="title">Loading Opening...</h3>
            <div id="lineList"></div>
        </div>
    </main>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script>
        let board, game = new Chess(), repo = [], moves = [], idx = 0, currentIdx = 0;
        let myColor = 'white';

        async function load() {
            const url = localStorage.getItem('opening_url');
            const res = await fetch(url);
            const raw = await res.text();
            try { repo = JSON.parse(raw); } catch(e) { repo = [{name: "Opening", raw: raw}]; }
            
            document.getElementById('title').innerText = repo[0].name || "Lines";
            renderList();
            initBoard();
        }

        function initBoard() {
            board = Chessboard('board', {
                draggable: true, position: 'start',
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
                onDrop: onDrop, onSnapEnd: () => board.position(game.fen())
            });
        }

        function renderList() {
            const list = document.getElementById('lineList');
            list.innerHTML = repo.map((l, i) => `<div class="line-item ${i==currentIdx?'active':''}" onclick="selectLine(${i})">${l.name || 'Variation '+(i+1)}</div>`).join('');
        }

        function selectLine(i) {
            currentIdx = i;
            renderList();
            startAs(myColor);
        }

        function startAs(color) {
            myColor = color;
            game.reset();
            board.orientation(color);
            board.start();
            moves = new Chess();
            moves.load_pgn(repo[currentIdx].raw.replace(/\[.*?\]/g, ''));
            moves = moves.history();
            idx = 0;
            document.getElementById('msg').innerText = (color === 'white') ? "Your turn (White)" : "White is moving...";
            
            if(color === 'black') {
                setTimeout(computerMove, 600);
            }
        }

        function onDrop(source, target) {
            const move = game.move({ from: source, to: target, promotion: 'q' });
            if (!move || move.san !== moves[idx]) { if(move) game.undo(); return 'snapback'; }
            
            idx++;
            if(idx < moves.length) {
                setTimeout(computerMove, 500);
            } else { document.getElementById('msg').innerText = "Line Complete!"; }
        }

        function computerMove() {
            game.move(moves[idx++]);
            board.position(game.fen());
            document.getElementById('msg').innerText = "Your turn";
            if(idx === moves.length) document.getElementById('msg').innerText = "Line Complete!";
        }

        window.onload = load;
    </script>
</body>
</html>
