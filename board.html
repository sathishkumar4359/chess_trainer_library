<!DOCTYPE html>
<html>
<head>
    <title>ChessReps | Trainer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body { background: #09090b; color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { background: #18181b; padding: 15px; border-bottom: 1px solid #27272a; display: flex; justify-content: center; gap: 10px; }
        .white-1e1d7 { background-color: #ebecd0 !important; } .black-3c85d { background-color: #779556 !important; }
        main { display: flex; flex: 1; flex-wrap: wrap; }
        .board-area { flex: 2; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        #board { width: 90vw; max-width: 450px; border: 5px solid #27272a; border-radius: 4px; }
        .sidebar { flex: 1; background: #18181b; border-left: 1px solid #27272a; padding: 20px; min-width: 300px; }
        button { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-main { background: #81b64c; color: white; }
        .btn-dark { background: #27272a; color: white; }
        #msg { margin-top: 15px; color: #81b64c; font-weight: bold; font-size: 1.1rem; }
    </style>
</head>
<body>
    <header>
        <button class="btn-dark" onclick="window.location.href='index.html'">BACK</button>
        <button class="btn-main" onclick="init('white')">PLAY WHITE</button>
        <button class="btn-main" style="background:#444" onclick="init('black')">PLAY BLACK</button>
    </header>
    <main>
        <div class="board-area">
            <div id="board"></div>
            <div id="msg">Choose a side to start</div>
        </div>
        <div class="sidebar">
            <h2 id="title">Trainer</h2>
            <div id="status-box" style="background:#09090b; padding:15px; border-radius:8px; border:1px solid #27272a;">
                <p style="color:#71717a;">Moves will appear here...</p>
            </div>
        </div>
    </main>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script>
        let board, game = new Chess(), fullMoves = [], moveIdx = 0;
        
        async function init(color) {
            const url = localStorage.getItem('active_url');
            if(!url) return;
            const res = await fetch(url);
            const text = await res.text();
            
            // Handle PGN or JSON
            let pgnString = text;
            try { const data = JSON.parse(text); pgnString = data[0].raw || data.raw; } catch(e) {}
            
            game.reset();
            game.load_pgn(pgnString.replace(/\[.*?\]/g, ''));
            fullMoves = game.history();
            game.reset();
            moveIdx = 0;

            board = Chessboard('board', {
                draggable: true, position: 'start', orientation: color,
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
                onDrop: (s, t) => {
                    const move = game.move({ from: s, to: t, promotion: 'q' });
                    if (!move || move.san !== fullMoves[moveIdx]) { if(move) game.undo(); return 'snapback'; }
                    moveIdx++;
                    if(moveIdx < fullMoves.length) setTimeout(() => { game.move(fullMoves[moveIdx++]); board.position(game.fen()); }, 500);
                    else document.getElementById('msg').innerText = "Perfect! Line Complete.";
                }
            });
            if(color === 'black') setTimeout(() => { game.move(fullMoves[moveIdx++]); board.position(game.fen()); }, 600);
            document.getElementById('msg').innerText = "Your turn";
        }
    </script>
</body>
</html>
